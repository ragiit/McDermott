@page "/clinic-service/wellness/{PageMode}"
@rendermode InteractiveServer

<PageTitle>@Helper.APP_NAME - Wellness</PageTitle>

@if (IsAccess && UserAccessCRUID is not null && UserAccessCRUID.IsRead)
{
    <div class="wrapper">
        <BaseHeaderPage Title="Wellness" OnClickBack="@(async () => NavigationManager.NavigateTo("clinic-service/wellness"))" ShowBackButton="true" />

        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col">
                        <DxLoadingPanel @bind-Visible="PanelVisible"
                                        IndicatorAnimationType="WaitIndicatorAnimationType.Pulse"
                                        IsContentBlocked="true"
                                        ApplyBackgroundShading="true"
                                        IndicatorAreaVisible="false"
                                        Text="Fetching Data...">
                            <EditForm Context="L" Model="@WellnessProgram" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                <AntiforgeryToken />


                                <div class="row justify-content-end mb-3">
                                    <div class="col-auto align-self-end">
                                        <DxTabs>
                                            <DxTab Text="Draft" Enabled="@IsStatus(EnumWellness.Draft)"></DxTab>
                                            <DxTab Text="Active" Enabled="@IsStatus(EnumWellness.Active)"></DxTab>
                                            <DxTab Text="Completed" Enabled="@IsStatus(EnumWellness.Completed)"></DxTab>
                                            <DxTab Text="InActive" Enabled="@IsStatus(EnumWellness.Inactive)"></DxTab>
                                        </DxTabs>
                                    </div>
                                </div>

                                @if (!IsStatus(EnumWellness.Completed) && !IsStatus(EnumWellness.Inactive))
                                {
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row w-100 justify-content-end mt-2 mb-2">

                                                <div class="col-auto pe-0 ">
                                                    <DxButton Enabled="!IsLoading"
                                                              IconCssClass="fa-solid fa-check"
                                                              Text="@StagingText.GetDisplayName()"
                                                              Click="ClickConfirm"
                                                              RenderStyle="ButtonRenderStyle.Primary">
                                                    </DxButton>
                                                    <DxButton Enabled="!IsLoading"
                                                              IconCssClass="fa-solid fa-xmark"
                                                              Text="Cancel"
                                                              Click="OnCancelStatus"
                                                              RenderStyle="ButtonRenderStyle.Danger">
                                                    </DxButton>
                                                </div>

                                                <div class="col-sm align-self-end">
                                                    <div class="row justify-content-end">
                                                        <div class="col-auto">
                                                            <DxButton RenderStyle="ButtonRenderStyle.Primary" RenderStyleMode="@ButtonRenderStyleMode.Contained" IconCssClass="fa-solid fa-floppy-disk" Text="Save" SubmitFormOnClick="true">
                                                            </DxButton>
                                                            <DxButton RenderStyle="ButtonRenderStyle.Danger" RenderStyleMode="@ButtonRenderStyleMode.Contained" IconCssClass="fa-solid fa-xmark" Text="Close" Click="CancelForm_Click"></DxButton>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }

                                <div class="card">
                                    <div class="card-body">
                                        <DxFormLayout CssClass="w-100">
                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Program Name" ColSpanMd="12">
                                                <MyTextBox @bind-Text="@WellnessProgram.Name"
                                                           NullText="Name" />
                                                <ValidationMessage For="@(() => WellnessProgram.Name)" />
                                            </DxFormLayoutItem>

                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Category" ColSpanMd="12">
                                                <MyDxComboBox Data="@Categories"
                                                              @bind-Value="@WellnessProgram.Category"
                                                              NullText="Select Category"
                                                              ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Never" />
                                                <ValidationMessage For="@(() => WellnessProgram.Category)" />
                                            </DxFormLayoutItem>

                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Start Date" ColSpanMd="12">
                                                <DxDateEdit @bind-Date="@WellnessProgram.StartDate" />
                                            </DxFormLayoutItem>

                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="End Date" ColSpanMd="12">
                                                <DxDateEdit @bind-Date="@WellnessProgram.EndDate" />
                                            </DxFormLayoutItem>

                                            <DxFormLayoutItem Visible="@(!string.IsNullOrWhiteSpace(WellnessProgram.Slug))" CaptionCssClass="normal-caption" Caption="Link" ReadOnly ColSpanMd="12">
                                                <DxMaskedInput @bind-Value="@WellnessProgram.Slug"
                                                               NullText="Slug">
                                                    <Buttons>
                                                        <DxEditorButton CssClass="text-bold btn-primary" Text="Open Link" />
                                                    </Buttons>
                                                </DxMaskedInput>
                                            </DxFormLayoutItem>

                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Content" ColSpanMd="12">
                                            </DxFormLayoutItem>
                                        </DxFormLayout>
                                    </div>
                                </div>

                                @if (WellnessProgram.Id != 0)
                                {
                                    <div class="w-100">
                                        <div class="card">
                                            <div class="card-body">
                                                <DxTabs>
                                                    <DxTabPage CssClass="w-100" Text="Activities Details">
                                                        <div class="card">
                                                            <div class="card-body">

                                                                <MyGridPaginate @ref="GridSessionSchedule"
                                                                                Data="@WellnessProgramSessions"
                                                                                @bind-SelectedDataItems="@SelectedDataItemWellnessProgramSessions"
                                                                                KeyFieldName="Id"
                                                                                FocusedRowChanged="GridFocusedRowSessionVisibleIndex_FocusedRowChanged"
                                                                                EditModelSaving="OnSaveSchedule"
                                                                                SearchTextChanged="OnSearchBoxChangedWellnessProgramSession"
                                                                                DataItemDeleting="OnDeleteAttendence"
                                                                                RowDoubleClick="EditSession_Click">
                                                                    <ToolbarTemplate>
                                                                        <MyDxToolbarBase TItem="WellnessProgramSessionDto"
                                                                                         Items="@WellnessProgramSessions"
                                                                                         NewItem_Click="NewSession_Click"
                                                                                         EditItem_Click="EditSession_Click"
                                                                                         DeleteItem_Click="DeleteSession_Click"
                                                                                         Refresh_Click="RefreshSessions_Click" />
                                                                    </ToolbarTemplate>
                                                                    <Columns>
                                                                        <DxGridDataColumn FieldName="Name" Caption="Name" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="Day" Caption="Day" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="StartTime" Caption="Start Time" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="EndTime" Caption="End Time" MinWidth="100" />
                                                                    </Columns>
                                                                    <EditFormTemplate Context="EditFormContext">
                                                                        @{
                                                                            var a = (WellnessProgramSessionDto)EditFormContext.EditModel;
                                                                        }
                                                                        <DxFormLayout CssClass="w-100">
                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Name" ColSpanMd="12">
                                                                                <MyTextBox @bind-Text="@WellnessProgram.Name"
                                                                                           ShowValidationIcon="true"
                                                                                           ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                           NullText="Name" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Day" ColSpanMd="12">
                                                                                <DxComboBox Data="@(new[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" })"
                                                                                            @bind-Value="@a.Day"
                                                                                            NullText="Select Day" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Start Time" ColSpanMd="12">
                                                                                <DxDateEdit @bind-Date="@a.StartTime" TimeSectionVisible="true" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="End Time" ColSpanMd="12">
                                                                                <DxDateEdit @bind-Date="@a.EndTime" TimeSectionVisible="true" />
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditFormTemplate>
                                                                </MyGridPaginate>
                                                            </div>
                                                        </div>
                                                    </DxTabPage>
                                                    <DxTabPage CssClass="w-100" Text="Participants">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <MyGridPaginate @ref="GridAttendance"
                                                                                Data="@WellnessProgramAttendances"
                                                                                @bind-SelectedDataItems="@SelectedDataItemWellnessProgramAttendances"
                                                                                KeyFieldName="Id"
                                                                                FocusedRowChanged="GridFocusedRowScheduleVisibleIndex_FocusedRowChanged"
                                                                                EditModelSaving="OnSaveAttendence"
                                                                                SearchTextChanged="OnSearchBoxChangedWellnessProgramAttendanceAttendance"
                                                                                DataItemDeleting="OnDeleteAttendence"
                                                                                RowDoubleClick="EditAttendance_Click">
                                                                    <ToolbarTemplate>
                                                                        <MyDxToolbarBase TItem="WellnessProgramAttendanceDto"
                                                                                         Items="@WellnessProgramAttendances"
                                                                                         NewItem_Click="NewAttendance_Click"
                                                                                         EditItem_Click="EditAttendance_Click"
                                                                                         DeleteItem_Click="DeleteAttendance_Click"
                                                                                         Refresh_Click="RefreshAttendance_Click" />
                                                                    </ToolbarTemplate>
                                                                    <Columns>
                                                                        <DxGridDataColumn FieldName="PatientName" Caption="Patient Name" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceDate" Caption="Attendance Date" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceStatus" Caption="Status" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="Notes" Caption="Notes" MinWidth="200" />
                                                                    </Columns>
                                                                    <EditFormTemplate Context="EditFormContext">
                                                                        @{
                                                                            var a = (WellnessProgramAttendanceDto)EditFormContext.EditModel;
                                                                        }
                                                                        <DxFormLayout CssClass="w-100">
                                                                            @*  <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Patient Name" ColSpanMd="12">
                                                                    <MyTextBox @bind-Text="@a.user" NullText="Enter Patient Name" />
                                                                    </DxFormLayoutItem> *@

                                                                            <DxFormLayoutItem CaptionCssClass="required-caption normal-caption" Caption="User" ColSpanMd="12">
                                                                                <MyDxComboBox Data="@Users"
                                                                                              NullText="Select User"
                                                                                              @ref="refUserComboBox"
                                                                                              @bind-Value="@a.PatientId"
                                                                                              TextFieldName="Name"
                                                                                              ValueFieldName="Id"
                                                                                              TextChanged="((string e) => OnInputUserChanged(e))">
                                                                                    <Buttons>
                                                                                        <DxEditorButton Click="OnSearchUserIndexDecrement"
                                                                                                        IconCssClass="fa-solid fa-caret-left"
                                                                                                        Tooltip="Previous Index" />
                                                                                        <DxEditorButton Click="OnSearchUser"
                                                                                                        IconCssClass="fa-solid fa-magnifying-glass"
                                                                                                        Tooltip="Search" />
                                                                                        <DxEditorButton Click="OnSearchUserIndexIncrement"
                                                                                                        IconCssClass="fa-solid fa-caret-right"
                                                                                                        Tooltip="Next Index" />
                                                                                    </Buttons>
                                                                                    <Columns>
                                                                                        <DxListEditorColumn FieldName="@nameof(UserDto.Name)" Caption="Name" />
                                                                                    </Columns>
                                                                                </MyDxComboBox>
                                                                                <ValidationMessage For="@(()=>a.PatientId)" />
                                                                            </DxFormLayoutItem>


                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Attendance Date" ColSpanMd="12">
                                                                                <DxDateEdit @bind-Date="@a.AttendanceDate" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Status" ColSpanMd="12">
                                                                                <DxComboBox Data="@(new[] { "Present", "Absent", "Excused" })"
                                                                                            @bind-Value="@a.AttendanceStatus"
                                                                                            NullText="Select Status" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Notes" ColSpanMd="12">
                                                                                <MyTextBox @bind-Text="@a.Comments" NullText="Enter Notes" />
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditFormTemplate>
                                                                </MyGridPaginate>
                                                            </div>
                                                        </div>
                                                    </DxTabPage>
                                                    <DxTabPage CssClass="w-100" Text="Attendences">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <MyGridPaginate @ref="GridAttendance"
                                                                                Data="@WellnessProgramAttendances"
                                                                                @bind-SelectedDataItems="@SelectedDataItemWellnessProgramAttendances"
                                                                                KeyFieldName="Id"
                                                                                FocusedRowChanged="GridFocusedRowScheduleVisibleIndex_FocusedRowChanged"
                                                                                EditModelSaving="OnSaveAttendence"
                                                                                SearchTextChanged="OnSearchBoxChangedWellnessProgramAttendanceAttendance"
                                                                                DataItemDeleting="OnDeleteAttendence"
                                                                                RowDoubleClick="EditAttendance_Click">
                                                                    <ToolbarTemplate>
                                                                        <MyDxToolbarBase TItem="WellnessProgramAttendanceDto"
                                                                                         Items="@WellnessProgramAttendances"
                                                                                         NewItem_Click="NewAttendance_Click"
                                                                                         EditItem_Click="EditAttendance_Click"
                                                                                         DeleteItem_Click="DeleteAttendance_Click"
                                                                                         Refresh_Click="RefreshAttendance_Click" />
                                                                    </ToolbarTemplate>
                                                                    <Columns>
                                                                        <DxGridDataColumn FieldName="PatientName" Caption="Patient Name" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceDate" Caption="Attendance Date" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceStatus" Caption="Status" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="Notes" Caption="Notes" MinWidth="200" />
                                                                    </Columns>
                                                                    <EditFormTemplate Context="EditFormContext">
                                                                        @{
                                                                            var a = (WellnessProgramAttendanceDto)EditFormContext.EditModel;
                                                                        }
                                                                        <DxFormLayout CssClass="w-100">
                                                                            @*  <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Patient Name" ColSpanMd="12">
                                                                    <MyTextBox @bind-Text="@a.user" NullText="Enter Patient Name" />
                                                                    </DxFormLayoutItem> *@

                                                                            <DxFormLayoutItem CaptionCssClass="required-caption normal-caption" Caption="User" ColSpanMd="12">
                                                                                <MyDxComboBox Data="@Users"
                                                                                              NullText="Select User"
                                                                                              @ref="refUserComboBox"
                                                                                              @bind-Value="@a.PatientId"
                                                                                              TextFieldName="Name"
                                                                                              ValueFieldName="Id"
                                                                                              TextChanged="((string e) => OnInputUserChanged(e))">
                                                                                    <Buttons>
                                                                                        <DxEditorButton Click="OnSearchUserIndexDecrement"
                                                                                                        IconCssClass="fa-solid fa-caret-left"
                                                                                                        Tooltip="Previous Index" />
                                                                                        <DxEditorButton Click="OnSearchUser"
                                                                                                        IconCssClass="fa-solid fa-magnifying-glass"
                                                                                                        Tooltip="Search" />
                                                                                        <DxEditorButton Click="OnSearchUserIndexIncrement"
                                                                                                        IconCssClass="fa-solid fa-caret-right"
                                                                                                        Tooltip="Next Index" />
                                                                                    </Buttons>
                                                                                    <Columns>
                                                                                        <DxListEditorColumn FieldName="@nameof(UserDto.Name)" Caption="Name" />
                                                                                    </Columns>
                                                                                </MyDxComboBox>
                                                                                <ValidationMessage For="@(()=>a.PatientId)" />
                                                                            </DxFormLayoutItem>


                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Attendance Date" ColSpanMd="12">
                                                                                <DxDateEdit @bind-Date="@a.AttendanceDate" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Status" ColSpanMd="12">
                                                                                <DxComboBox Data="@(new[] { "Present", "Absent", "Excused" })"
                                                                                            @bind-Value="@a.AttendanceStatus"
                                                                                            NullText="Select Status" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Notes" ColSpanMd="12">
                                                                                <MyTextBox @bind-Text="@a.Comments" NullText="Enter Notes" />
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditFormTemplate>
                                                                </MyGridPaginate>
                                                            </div>
                                                        </div>
                                                    </DxTabPage>

                                                    <DxTabPage CssClass="w-100" Text="Attendance">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <MyGridPaginate @ref="GridAttendance"
                                                                                Data="@WellnessProgramAttendances"
                                                                                @bind-SelectedDataItems="@SelectedDataItemWellnessProgramAttendances"
                                                                                KeyFieldName="Id"
                                                                                FocusedRowChanged="GridFocusedRowScheduleVisibleIndex_FocusedRowChanged"
                                                                                EditModelSaving="OnSaveAttendence"
                                                                                SearchTextChanged="OnSearchBoxChangedWellnessProgramAttendanceAttendance"
                                                                                DataItemDeleting="OnDeleteAttendence"
                                                                                RowDoubleClick="EditAttendance_Click">
                                                                    <ToolbarTemplate>
                                                                        <MyDxToolbarBase TItem="WellnessProgramAttendanceDto"
                                                                                         Items="@WellnessProgramAttendances"
                                                                                         NewItem_Click="NewAttendance_Click"
                                                                                         EditItem_Click="EditAttendance_Click"
                                                                                         DeleteItem_Click="DeleteAttendance_Click"
                                                                                         Refresh_Click="RefreshAttendance_Click" />
                                                                    </ToolbarTemplate>
                                                                    <Columns>
                                                                        <DxGridDataColumn FieldName="PatientName" Caption="Patient Name" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceDate" Caption="Attendance Date" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="AttendanceStatus" Caption="Status" MinWidth="100" />
                                                                        <DxGridDataColumn FieldName="Notes" Caption="Notes" MinWidth="200" />
                                                                    </Columns>
                                                                    <EditFormTemplate Context="EditFormContext">
                                                                        @{
                                                                            var a = (WellnessProgramAttendanceDto)EditFormContext.EditModel;
                                                                        }
                                                                        <DxFormLayout CssClass="w-100">
                                                                            @*  <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Patient Name" ColSpanMd="12">
                                                                    <MyTextBox @bind-Text="@a.user" NullText="Enter Patient Name" />
                                                                    </DxFormLayoutItem> *@

                                                                            <DxFormLayoutItem CaptionCssClass="required-caption normal-caption" Caption="User" ColSpanMd="12">
                                                                                <MyDxComboBox Data="@Users"
                                                                                              NullText="Select User"
                                                                                              @ref="refUserComboBox"
                                                                                              @bind-Value="@a.PatientId"
                                                                                              TextFieldName="Name"
                                                                                              ValueFieldName="Id"
                                                                                              TextChanged="((string e) => OnInputUserChanged(e))">
                                                                                    <Buttons>
                                                                                        <DxEditorButton Click="OnSearchUserIndexDecrement"
                                                                                                        IconCssClass="fa-solid fa-caret-left"
                                                                                                        Tooltip="Previous Index" />
                                                                                        <DxEditorButton Click="OnSearchUser"
                                                                                                        IconCssClass="fa-solid fa-magnifying-glass"
                                                                                                        Tooltip="Search" />
                                                                                        <DxEditorButton Click="OnSearchUserIndexIncrement"
                                                                                                        IconCssClass="fa-solid fa-caret-right"
                                                                                                        Tooltip="Next Index" />
                                                                                    </Buttons>
                                                                                    <Columns>
                                                                                        <DxListEditorColumn FieldName="@nameof(UserDto.Name)" Caption="Name" />
                                                                                    </Columns>
                                                                                </MyDxComboBox>
                                                                                <ValidationMessage For="@(()=>a.PatientId)" />
                                                                            </DxFormLayoutItem>


                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Attendance Date" ColSpanMd="12">
                                                                                <DxDateEdit @bind-Date="@a.AttendanceDate" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Status" ColSpanMd="12">
                                                                                <DxComboBox Data="@(new[] { "Present", "Absent", "Excused" })"
                                                                                            @bind-Value="@a.AttendanceStatus"
                                                                                            NullText="Select Status" />
                                                                            </DxFormLayoutItem>

                                                                            <DxFormLayoutItem CaptionCssClass="normal-caption" Caption="Notes" ColSpanMd="12">
                                                                                <MyTextBox @bind-Text="@a.Comments" NullText="Enter Notes" />
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditFormTemplate>
                                                                </MyGridPaginate>
                                                            </div>
                                                        </div>
                                                    </DxTabPage>
                                                </DxTabs>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </EditForm>
                        </DxLoadingPanel>
                    </div>
                </div>
            </div>
        </section>
    </div>
}
else if (UserAccessCRUID is not null && !UserAccessCRUID.IsRead)
{
    <InvalidPermissionPage />
}
else
{
    <LoadingIndicatorLayout />
}